services:
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:16-alpine}
    container_name: webhook-postgres
    profiles:
      - embedded-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-webhook_platform}
      POSTGRES_USER: ${POSTGRES_USER:-webhook_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-webhook_pass}
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    volumes:
      - ${POSTGRES_VOLUME_NAME:-webhook_pgdata}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-webhook_user} -d ${POSTGRES_DB:-webhook_platform}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - webhook-network
    restart: unless-stopped

  kafka:
    image: ${KAFKA_IMAGE:-apache/kafka:3.7.0}
    container_name: webhook-kafka
    ports:
      - "127.0.0.1:9092:9092"
      - "127.0.0.1:9093:9093"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: ${KAFKA_NUM_PARTITIONS:-12}
      KAFKA_MIN_INSYNC_REPLICAS: 1
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      CLUSTER_ID: webhook-kafka-cluster
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9092 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - webhook-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G

  redis:
    image: ${REDIS_IMAGE:-redis:7-alpine}
    container_name: webhook-redis
    ports:
      - "127.0.0.1:${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes --maxmemory ${REDIS_MAXMEMORY:-256mb} --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD:-webhook_redis_pass}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-webhook_redis_pass}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - webhook-network
    restart: unless-stopped

  minio:
    image: ${MINIO_IMAGE:-minio/minio:RELEASE.2024-01-16T16-07-38Z}
    container_name: webhook-minio
    command: server /data --console-address ":9001"
    profiles:
      - minio
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio_admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - webhook-network
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: ./webhook-platform-api/Dockerfile
    image: webhook-platform-api:${API_IMAGE_TAG:-latest}
    container_name: webhook-api
    ports:
      - "${API_PORT:-8080}:8080"
    environment:
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-webhook_platform}
      DB_USER: ${DB_USER:-webhook_user}
      DB_PASSWORD: ${DB_PASSWORD:-webhook_pass}
      DB_SSL_MODE: ${DB_SSL_MODE:-disable}
      DB_JDBC_URL: ${DB_JDBC_URL:-}
      DB_POOL_MAX_SIZE: ${DB_POOL_MAX_SIZE:-10}
      DB_POOL_MIN_IDLE: ${DB_POOL_MIN_IDLE:-5}
      DB_POOL_CONNECTION_TIMEOUT: ${DB_POOL_CONNECTION_TIMEOUT:-30000}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 8080
      WEBHOOK_ENCRYPTION_KEY: ${WEBHOOK_ENCRYPTION_KEY:?WEBHOOK_ENCRYPTION_KEY must be set}
      WEBHOOK_ENCRYPTION_SALT: ${WEBHOOK_ENCRYPTION_SALT:?WEBHOOK_ENCRYPTION_SALT must be set}
      WEBHOOK_MAX_PAYLOAD_SIZE_BYTES: ${WEBHOOK_MAX_PAYLOAD_SIZE_BYTES:-262144}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET must be set}
      DATA_RETENTION_OUTBOX_DAYS: ${DATA_RETENTION_OUTBOX_DAYS:-7}
      DATA_RETENTION_ATTEMPTS_DAYS: ${DATA_RETENTION_ATTEMPTS_DAYS:-90}
      DATA_RETENTION_MAX_ATTEMPTS_PER_DELIVERY: ${DATA_RETENTION_MAX_ATTEMPTS_PER_DELIVERY:-10}
      DATA_RETENTION_BATCH_SIZE: ${DATA_RETENTION_BATCH_SIZE:-1000}
      DATA_RETENTION_CRON: ${DATA_RETENTION_CRON:-0 0 2 * * *}
      DATA_RETENTION_LIMIT_CRON: ${DATA_RETENTION_LIMIT_CRON:-0 */30 * * * *}
      EVENT_INGESTION_RATE_LIMIT_PER_SECOND: ${EVENT_INGESTION_RATE_LIMIT_PER_SECOND:-100}
      AUTH_RATE_LIMIT_LOGIN_PER_MINUTE: ${AUTH_RATE_LIMIT_LOGIN_PER_MINUTE:-10}
      AUTH_RATE_LIMIT_REGISTER_PER_MINUTE: ${AUTH_RATE_LIMIT_REGISTER_PER_MINUTE:-5}
      WEBHOOK_ALLOW_PRIVATE_IPS: ${WEBHOOK_ALLOW_PRIVATE_IPS:-true}
      WEBHOOK_ALLOWED_HOSTS: ${WEBHOOK_ALLOWED_HOSTS:-}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:5173}
      TEST_ENDPOINT_BASE_URL: ${TEST_ENDPOINT_BASE_URL:-http://webhook-api:8080}
      TEST_ENDPOINT_MAX_PER_PROJECT: ${TEST_ENDPOINT_MAX_PER_PROJECT:-10}
      TEST_ENDPOINT_MAX_TTL_HOURS: ${TEST_ENDPOINT_MAX_TTL_HOURS:-72}
      TEST_ENDPOINT_CLEANUP_INTERVAL_MS: ${TEST_ENDPOINT_CLEANUP_INTERVAL_MS:-3600000}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      SWAGGER_ENABLED: ${SWAGGER_ENABLED:-true}
      METRICS_ENABLED: ${METRICS_ENABLED:-true}
      APP_ENV: ${APP_ENV:-development}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-webhook_redis_pass}
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@hookflow.dev}
      EMAIL_BASE_URL: ${EMAIL_BASE_URL:-http://localhost:5173}
      SMTP_HOST: ${SMTP_HOST:-localhost}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_AUTH: ${SMTP_AUTH:-false}
      SMTP_STARTTLS: ${SMTP_STARTTLS:-false}
      JAVA_OPTS: ${API_JAVA_OPTS:-}
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - webhook-network
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: ./webhook-platform-worker/Dockerfile
    image: webhook-platform-worker:${WORKER_IMAGE_TAG:-latest}
    container_name: webhook-worker
    ports:
      - "${WORKER_PORT:-8081}:8081"
    environment:
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-webhook_platform}
      DB_USER: ${DB_USER:-webhook_user}
      DB_PASSWORD: ${DB_PASSWORD:-webhook_pass}
      DB_SSL_MODE: ${DB_SSL_MODE:-disable}
      DB_JDBC_URL: ${DB_JDBC_URL:-}
      DB_POOL_MAX_SIZE: ${DB_POOL_MAX_SIZE:-10}
      DB_POOL_MIN_IDLE: ${DB_POOL_MIN_IDLE:-5}
      DB_POOL_CONNECTION_TIMEOUT: ${DB_POOL_CONNECTION_TIMEOUT:-30000}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      MANAGEMENT_PORT: 8081
      WEBHOOK_ENCRYPTION_KEY: ${WEBHOOK_ENCRYPTION_KEY:?WEBHOOK_ENCRYPTION_KEY must be set}
      WEBHOOK_ENCRYPTION_SALT: ${WEBHOOK_ENCRYPTION_SALT:?WEBHOOK_ENCRYPTION_SALT must be set}
      WEBHOOK_ALLOW_PRIVATE_IPS: ${WEBHOOK_ALLOW_PRIVATE_IPS:-true}
      WEBHOOK_ALLOWED_HOSTS: ${WEBHOOK_ALLOWED_HOSTS:-}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      APP_ENV: ${APP_ENV:-development}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-webhook_redis_pass}
      ORDERING_GAP_TIMEOUT_SECONDS: ${ORDERING_GAP_TIMEOUT_SECONDS:-60}
      ORDERING_DELIVERED_SEQ_TTL_HOURS: ${ORDERING_DELIVERED_SEQ_TTL_HOURS:-24}
      ORDERING_BUFFER_TTL_MINUTES: ${ORDERING_BUFFER_TTL_MINUTES:-10}
      STUCK_DELIVERY_THRESHOLD_MINUTES: ${STUCK_DELIVERY_THRESHOLD_MINUTES:-5}
      STUCK_DELIVERY_CHECK_INTERVAL_MS: ${STUCK_DELIVERY_CHECK_INTERVAL_MS:-60000}
      RETRY_SCHEDULER_BATCH_SIZE: ${RETRY_SCHEDULER_BATCH_SIZE:-100}
      RETRY_SCHEDULER_SEND_TIMEOUT_SECONDS: ${RETRY_SCHEDULER_SEND_TIMEOUT_SECONDS:-30}
      RETRY_SCHEDULER_RESCHEDULE_DELAY_SECONDS: ${RETRY_SCHEDULER_RESCHEDULE_DELAY_SECONDS:-60}
      RETRY_SCHEDULER_POLL_INTERVAL_MS: ${RETRY_SCHEDULER_POLL_INTERVAL_MS:-10000}
      JAVA_OPTS: ${WORKER_JAVA_OPTS:-}
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    stop_grace_period: 35s
    networks:
      - webhook-network
    restart: unless-stopped

  ui:
    build:
      context: .
      dockerfile: ./webhook-platform-ui/Dockerfile
    image: webhook-platform-ui:${UI_IMAGE_TAG:-latest}
    container_name: webhook-ui
    ports:
      - "${UI_PORT:-5173}:5173"
    environment:
      VITE_API_URL: ${VITE_API_URL:-}
    depends_on:
      - api
    networks:
      - webhook-network
    restart: unless-stopped

volumes:
  webhook_pgdata:
    name: ${POSTGRES_VOLUME_NAME:-webhook_pgdata}
  kafka_data:
  redis_data:
  minio_data:

networks:
  webhook-network:
    driver: bridge
